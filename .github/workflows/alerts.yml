name: Crypto Market Gateway Alerts

on:
  schedule:
    # Runs every 5 minutes (UTC)
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  ping-alert:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Call /api/alert (real run)
        env:
          ALERT_URL: ${{ secrets.ALERT_URL }}
          ALERT_SECRET: ${{ secrets.ALERT_SECRET }}
          DEFAULT_SYMBOLS: ${{ secrets.DEFAULT_SYMBOLS }}
          DRIVER_TF: ${{ secrets.DRIVER_TF }}
        run: |
          set -euo pipefail

          SYMBOLS="${DEFAULT_SYMBOLS:-BTCUSDT,ETHUSDT,LDOUSDT}"
          TF="${DRIVER_TF:-5m}"

          URL="${ALERT_URL}?key=${ALERT_SECRET}&symbols=${SYMBOLS}&driver_tf=${TF}"

          echo "Hitting: ${ALERT_URL} (symbols=${SYMBOLS}, tf=${TF})"

          # Retry a few times for transient failures
          curl -sS --fail \
            --retry 3 --retry-delay 2 --retry-all-errors \
            "${URL}"